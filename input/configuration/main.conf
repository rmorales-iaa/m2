#==============================================================================
#Start of configuration file
#==============================================================================
AbsolutePath {
  #----------------------------------------------------------------------------
  base_local_path = "/home/rafa/proyecto/m2"
  #----------------------------------------------------------------------------
  nativeLibrary.path   = ${AbsolutePath.base_local_path}/native/
  #----------------------------------------------------------------------------
  fastFileList.library = "FastFileList" # file name in 'nativeLibrary.path': libFastFileList.so"
  #----------------------------------------------------------------------------
  fitsUtils.library    = "FitsUtils"
  #----------------------------------------------------------------------------
  jplSpice.library     = "JNISpice"
  #----------------------------------------------------------------------------
  wcsTools.library     = "wcstools"
  #----------------------------------------------------------------------------
  cgal.library         = "cgal"
  #----------------------------------------------------------------------------
} //End of AbsolutePath
#==============================================================================
Background {
  //---------------------------------------------------------------------------
  //Sextractor is 5s faster than the algorithm implemented in m2 (with equivalent results)
  //Sextractor has been modified in file "makeit.c" to write out a file with those values
  // (background and background RMS)
  //This output file has the same name as the catalog filename but with the suffix ".deleteme"
  //--------------------------------------------------------------------------
  useSextactor = true  //it true use sextractor for background estimation. If false, then use the m2 own algorithm
  //--------------------------------------------------------------------------
  m2_Algorithm {
    //------------------------------------------------------------------------
    meshSizeX = 64
    meshSizeY = 64
    //------------------------------------------------------------------------
    sigmaClipping {
      iteration = 3
      scale     = 3
    }
    //------------------------------------------------------------------------
  }
  //--------------------------------------------------------------------------
}//End of Background
#==============================================================================
Centroid {  //source centroid
  //--------------------------------------------------------------------------
  //valid options: cntrd (daophot)
  //               gcntrd (daophot)
  //               centrrOfMases
  //               sextractor
  algorithm = "cntrd"
  fallback  = "centrrOfMases"
  //--------------------------------------------------------------------------
}//End of CentROID
#==============================================================================
FWHM {  // full width at half maximum
  //---------------------------------------------------------------------------
  sources {
    //-------------------------------------------------------------------------
    psefx {
      scriptPath = "input/sextractor/"
      scriptName = "run"
    }
    //-------------------------------------------------------------------------
    //obtain the fwhm of a source using least square fit of a several types of 2D guassians: circular, elliptycal and mosfat
    //It dependes on python version 3.6 and the following python packages: numpy and scipy
    aspyLib {
      call = "python3 input/aspyLib/aspyLib.py"
    }
  }
  //-------------------------------------------------------------------------
  image { //average of the fwhm of the sources
    //valid options: psfex, sextractor, m2
    algorithm = "psfex"
    fallback  = "m2"
     //algorithm = "m2"
     //fallback  = "psfex"
  }
  //---------------------------------------------------------------------------
  algorithm {
    //-------------------------------------------------------------------------
    m2 {
      sigmaScale  = 2.5
    }
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
} //End of FWHM
#==============================================================================
Astrometry {
  //---------------------------------------------------------------------------
  scriptDirectory="input/astrometry.net"
  temporalDirectory="output/astrometry/"
  //-------------------------------------------------------------------------
  telescopeFilter {
    name = ["OSN_90", "CASLEO_215"]   //avoid the images from those telescopes
  }
  //---------------------------------------------------------------------------
  fitWcs {
    //-------------------------------------------------------------------------
    //algorithm = "poly"    //polynomial. No standard wcs fitting
    algorithm = "m2_a_net"  //astrometry net m2 porting of fit-wcs
   // algorithm = "lsst_orig"  //lsst implementation

    //-------------------------------------------------------------------------
    SIP_order = 0   //to avoid overfitting of the SIP polynomy is recommend to set the automatic selection setting this value to 0
    //-------------------------------------------------------------------------
    //table ranges from "pinpoint" windows program
    //highest order fit that is practical: 4th
    //format: SIP_ORDER MIN_SOURCE_COUNT MAX_SOURCE_COUNT
    automaticSelection = [
      1, 3, 18
      2, 19, 29
      3, 30, 44
      4, 45, 62
      4, 63, 83             //5th order is not practical
      4, 84, 107            //6th order is not practical
      4, 108, 2147483647 ]  //7th order is not practical
    //-------------------------------------------------------------------------

    raMaxAllowedResidualMas   = 300
    decMaxAllowedResidualMas  = 300

    xMaxAllowedResidualPix    = 0.5
    yMaxAllowedResidualPix    = 0.5

    sigmaClipping                            = 2.5 //0 value indicates no sigma clipping filtering applied
    //-------------------------------------------------------------------------
    maxIteration                             = 20
    //-------------------------------------------------------------------------
    matchRadiusMas                           = 1000  //radius in milli arcsec to find the cantidates to match a image source with a catalog source. Proper motion is considered
    //-------------------------------------------------------------------------
    additionalNoiseTideMultiplier            = 1.50 //Applied after the one used in each telescope
    //-------------------------------------------------------------------------
    astrometryDotNet {  //astrometry.net fit wcs algorithm
      //-----------------------------------------------------------------------
      doShift = 1 //shift of the CRPIX in SIP estimation
      sipInverseGridPointCount = 10 //value in the original code 10
      //-----------------------------------------------------------------------
    }
    //-------------------------------------------------------------------------
    lsst { //lsst fit wcs algorithm
      matchRadiousMas = 1000  //in milli arc sec
      fit_program     = "/home/rafa/proyecto/m2/input/lsst/cc_lsst_wcs_fit_ast"
    }
    //-------------------------------------------------------------------------
    polynomial {
      //degree to be added to the estimated polynomial degree (it depends of the source match count)
      //the total degree will determine the polynomy of the residuals used to estimate a position
      residualPolynomyAdditionalDegree     = 1
    }
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
  grouping {
    //-------------------------------------------------------------------------
    raStep  = 0.0001 //decimal degree
    decStep = 0.0001 //decimal degree
    //-------------------------------------------------------------------------
    maxRaRangePerImage   =  4 //decimal degree. Max ra range of an image
    maxDecRangePerImage  =  4 //decimal degree. Max dec range of an image
    //-------------------------------------------------------------------------
    maxRaRangePerGroup   =  2 //decimal degree
    maxDecRangePerGroup  =  2 //decimal degree
    //-------------------------------------------------------------------------
    extraRaRangePerGroup  =  0.006  //decimal degree
    extraDecRangePerGroup =  0.006  //decimal degree
    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
  catalog {
    //-------------------------------------------------------------------------
    croppy {
      defaultPixSizeX       = 10  //used when mpo was not found
      defaultPixSizeY       = 10  //used when mpo was not found
      minPixCount           = 3
      maxPixCount           = 5000
    }
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
} //End of Astrometry

#==============================================================================
Photometry {
  //---------------------------------------------------------------------------
  useBackgroundBySourceExtraction       = 0   //use source extraction algorithm to estimate local background (instead of annular and max appertures)
  //---------------------------------------------------------------------------
  maxSourceToCalulateAbsolutePhotometry = 0   //set to 0 to use all sources
  //---------------------------------------------------------------------------
  //magnitude check
  minValidMagnitude = 0
  maxValidMagnitude = 25
  //---------------------------------------------------------------------------
  //min percentage of pixels that intersects the rectangle hull of the source
  //low value inicates that source has elongated form (probably because is in contact with other source) and it is not valid
  sourceMinPixelInPercentage = 1//40
  //---------------------------------------------------------------------------
  //add this percentage to the min value and detect sources again. This is a simple way to detect local min and also blended sources
  stretchPercentage          = 50
  //---------------------------------------------------------------------------
  maxAllowedSourceSizeProportion  = 3 //proportion of x size and y size
  //---------------------------------------------------------------------------
  absolute {
    //-------------------------------------------------------------------------
    fitPolynomyDegree = 3
    //-------------------------------------------------------------------------
    sigmaClipping     = 2.5
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
  differential {
    //-------------------------------------------------------------------------
    maxClosestSourcesToFocus                             = 1000 //Set to 0 to consider all sources
    //-------------------------------------------------------------------------
    maxMagnitudeDiffAllowed                              = 3 //2  //set to 0 consider all sources
    //-------------------------------------------------------------------------
    maxDropRateAllowed                                   = 35
    //-------------------------------------------------------------------------
    borderImagePercentageToIgnore { //percentage of the image to be ignored when searching sources.
      xAxis                                              = 5  //applied to left and right border
      yAxis                                              = 5  //applied to top and bottom border
    }
    //-------------------------------------------------------------------------
    filter {
      //---------------------------------------------------------------------
      sourceCount {
        imageMaxSourceDropPercentageGroupAverage         = 35   //set to 0 to disable this filter
      }
      //-----------------------------------------------------------------------
      sigmaClipping {
        //---------------------------------------------------------------------
        image {
          focusEstFlux                           = 2.5 //set to 0 to disable this filter
        }
        //---------------------------------------------------------------------
        sourceEvolution {
          relativeFlux                           = 2.5 //set to 0 to disable this filter
          variableFlux                           = 2.5 //set to 0 to disable this filter
          linearFitting                          = 2.5 //set to 0 to disable this filter
        }
        //---------------------------------------------------------------------
      }
      //-----------------------------------------------------------------------
      maxAllowedStdDevEstMagnitude               = 3 //set to 0 to disable this filter
      //-----------------------------------------------------------------------
      linearFitting {  //(flux averag -> flux stdDev)
        minAllowedR2                             = 0.75
      }
      //-----------------------------------------------------------------------
    }
    //-------------------------------------------------------------------------
  }
  //---------------------------------------------------------------------------
  //---------------------------------------------------------------------------
} //End of Photometry
#==============================================================================
BellShapeFit {
  //---------------------------------------------------------------------------
  //0   => GAUSSIAN_2D_SIMPLE_FIT
  //1   => GAUSSIAN_2D_SIMPLE_CENTRAL_ROW_COL_FIT

  //2   => GAUSSIAN_2D_ELLIPTICAL_FIT
  //3   => GAUSSIAN_2D_ELLIPTICAL_ROTATED_FIT

  //10  => NORMAL_2D_ELLIPTICAL
  //11  => NORMAL_2D_ELLIPTICAL_ROTATED_FIT

  //20  => MOFFAT_ELLIPTICAL_2D_FIT
  //21  => MOFFAT_ELLIPTICAL_ROTATED_FIT

  //100 => ASPLIB_GAUSSIAN_2D_CIRCULAR_FIT
  //101 => ASPLIB_GAUSSIAN_2D_ELLIPTICAL_FIT
  //102 => ASPLIB_MOFFAT_2D_CIRCULAR_FIT
  //103 => ASPLIB_MOFFAT_2D_ELLIPTICAL_FIT

  fitAlgorithm =   21
  //---------------------------------------------------------------------------
  sampligRegionX = 0  //Extra pix size (in x direction) added to the surrounding source box to calcualte the fit
  sampligRegionY = 0  //Extra pix size (in y direction) added to the surrounding source box to calcualte the fit
  //---------------------------------------------------------------------------
}
#==============================================================================
//Use script 'update_mpc CURRENT_DATE' to update properly the orbital data to the observing date
AsteroidChecker {
  //---------------------------------------------------------------------------
  queryRadius     = 0.2   //in arcosec
  //---------------------------------------------------------------------------
  generateReportKnownSources = true
  queryDir        = "output/asteroidChecker/"
  script          = ${AbsolutePath.base_local_path}/input/asteroidChecker/run_script
  sofDir          = ${AbsolutePath.base_local_path}/input/asteroidChecker/find_orb/sof/
  //---------------------------------------------------------------------------
} //End of AsteroidChecker
#==============================================================================
JplSpice {
  //----------------------------------------------------------------------------
  localSPK_Repository = "input/spice/kernels/spk/objects"
  //---------------------------------------------------------------------------
  commonMetaKernel  = "input/spice/kernels/meta/m2_common_meta_kernel.txt"
  objectsKernelPath = "input/spice/kernels/spk/objects/"
  //---------------------------------------------------------------------------
}  //End of JplSpice
#==============================================================================
Query{
  #----------------------------------------------------------------------------
  gaiaTap{
    #GAIA database
    remoteGaiaDatabase = "gaiadr2.gaia_source"

    #ESA TAP server
    tapServer = "https://gea.esac.esa.int/tap-server/"

    #max row count of a query
    maxRowCount = 250000

    #query output path
    queryOutpuPath = "output/tap_query/gaia"

    #filter by magnitude
    applyFilterByMagnitude = false
    minMagnitude = 15.0
    maxMagnitude = 20.0
  } //end of gaia
  #----------------------------------------------------------------------------
} //End of query
#==============================================================================
Telescope {
  //---------------------------------------------------------------------------
  dir = "input/telescope"
  //---------------------------------------------------------------------------
} //end of Telescope
#==============================================================================
LightCurve {
  //---------------------------------------------------------------------------
  configurationFile = "input/lightCurve/lightCurve.conf"
  //---------------------------------------------------------------------------
} //end of LightCurve
#==============================================================================
Deblending {
  //---------------------------------------------------------------------------
  COSMOS {
    samplingLevel                     = 32     //number of levels to split the intenty range (from noide tide to max intensity)
    samplingExponentialStep           = true   //true use exponential steps, false use lineal steps
    minAllowedIntensityPercentage     = 5      //min intensity contribution percentage (regarding the actual pixel value)
    // of a source regarding a pixel, to consider this contribution valuable
  }
  //---------------------------------------------------------------------------
} //end of Deblending
#==============================================================================
FlexibleMatch {
  //---------------------------------------------------------------------------
  configurationFile = "input/flexibleMatch/flexibleMatch.conf"
  //---------------------------------------------------------------------------
}  //end of FlexibleMatch
#==============================================================================
Database {
  //---------------------------------------------------------------------------
  mongoDB {
    //-------------------------------------------------------------------------
    uri  = "mongodb://rafa:rafaMongoIAA@tikal:27017/?compressors=zlib"    //tikal instance
    #uri = "mongodb://rafa:rafaMongoIAA@localhost:27017/?compressors=zlib           //local instance
    //-------------------------------------------------------------------------
    gaia     = "input/database/gaia_dr_3.conf"     #Gaia data release 3
    #--------------------------------------------------------------------------
  }
  //-------------------------------------------------------------------------
  apass    = "input/database/apass_dr_10.conf"   #Apass DR 10
  #--------------------------------------------------------------------------
  vizier   = "input/database/vizier.conf"        #vizier
  #--------------------------------------------------------------------------
  simbad   = "input/database/simbad.conf"        #simbad
  //---------------------------------------------------------------------------
} //End of Database

#==============================================================================
RotationalPeriod {
  //---------------------------------------------------------------------------
  applySigmaClipping = 1
  sigmaScale           = 2.5
  //---------------------------------------------------------------------------
} //End of RotationalPeriod
#==============================================================================
Registration {
  //---------------------------------------------------------------------------
  configurationFile = "input/registration/registration.conf"
  //---------------------------------------------------------------------------
} //End of Registration
#==============================================================================
Occultation {
  //---------------------------------------------------------------------------
  configurationFile = "input/occultation/occultation.conf"
  //---------------------------------------------------------------------------
} //End of Registration
#==============================================================================
Spark {
  #----------------------------------------------------------------------------
  #Determine whether use spark  capabilities
  use = true

  #serializer
  kryoserializerBuffer = 32mb
  kryoserializerBufferMax = 1024mb

  #tmp directory. Fast a big disk
  temporalDirectory = "/home/rafa/hadoop/tmp/"
  #============================================================================
  driver{
    #Only in cluster deploy mode. See "http://spark.apache.org/docs/latest/configuration.html" hadoop.driver.memory
    resultSize = 1024mb
  }
  #============================================================================
  computationCluster {
    #--------------------------------------------------------------------------
    runInRemote = false      #set to true to run in the remote computation cluster
    #set to false to run in the local computer
    #--------------------------------------------------------------------------
    local {
      totalCore = 8  #total count of CPU cores used to be used in the local computer.
      memoryPerExecutor = 4g #total memory used in a single executor in GigiBytes
    }
    #--------------------------------------------------------------------------
    remote {
      yarn = none #set the yarn execution mode: "cluster", "client" or "none" (not using yarn)
      url = "spark://Nakbe:7077"
      executor{
        corePerExecutor = 2   #max number of CPU cores to be used in a single executor
        memoryPerExecutor = 3g    #max RAM memory in Gigabytes to be used in a single executor in GigiBytes
      }
    } //end of remote
    #--------------------------------------------------------------------------
  } //end of computationCluster
  //---------------------------------------------------------------------------
} //end of Spark
#==========================================================================
#hadoop configuration files in local file system
Hadoop{
  #--------------------------------------------------------------------------
  #Determine if use hadoop: 'true' or 'false'
  use = false

  #Also is possible to use haddop setting the variable HADOOP_CONF_DIR at "conf/hadoop-env.sh" keeping those variables as empty
  #but it only works with fat jar (not inside eclipse compiler)

  core = "/opt/hadoop/hadoop_latest/etc/hadoop/core-site.xml"
  hdfs = "/opt/hadoop/hadoop_latest/etc/hadoop/hdfs-site.xml"
  #--------------------------------------------------------------------------
} //end of Hadoop
#==============================================================================
Git {
  #--------------------------------------------------------------------------
  #git repository for remote updates
  #Remember to set properly the section "User.ssh.privateKeyFilePath" in this file

  #Determine whether use git
  use = false

  remoteRepoURL="ssh://git@XXX.XXX.XX.XXX:YYYY/media/data/server/git/update/moose"
  privateKeyFilePath= "/home/rafa/.ssh/id_rsa"  #absolute path

  #----------------------------------------------------------------------------
} //end of Git
#==============================================================================
Common {
  #----------------------------------------------------------------------------
  coreCount = -1
  //-1 indicates that all thread cores will be used
  //a integer number > 0 fix the number of cores to be used
  #----------------------------------------------------------------------------
  fitsFileExtension = [".fit", ".fts", ".fits"]
  #----------------------------------------------------------------------------
} //end of Common
#==============================================================================
#End of configuration file
#==============================================================================
